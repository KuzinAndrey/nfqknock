# nfqknockd - protect TCP port by cryptographic port-knocking

We has old port-knocking project [knock](https://github.com/jvinet/knock)
which based on [libpcap](https://github.com/the-tcpdump-group/libpcap) for capture packets.

This solution has some inconveniences:
- For doing his job daemon need to turn on [promisc mode](https://en.wikipedia.org/wiki/Promiscuous_mode) on
  working interface and generate special catch rules for pcap library, this is heavy workload
  with high network traffic.
- Knocking port sequences is hardcoded and can be sniffed by attacker and reproduce
  to open protected service.
- For open port knock daemon add new rules in iptables chains for every permitted IP.

**nfqknockd** - another try to solve port-knocking issue by using NFQUEUE target in
iptables and cryptographically generated periodically rotated knocking sequences.
Use only one iptables rule for all job.

How it work:
- Define working TCP port diapazon for NFQUEUE rule to catching all packets.
- Protected port **must be** in this working diapazon (this is our main limitation).
- Define open and close secret phrase.
- Secret port open/close sequences generated by one of cryptographic hash algorithms.
- For "salt" we use current hour unixtime.

Because of that we use less resources and more secure from attackers.

## Compile

Alpine Linux:
```sh
# Build dependencies
apk add libnfnetlink-dev
apk add libnetfilter_queue-dev

# Build project
make

# Install in /usr/local
make install
```

## Usage

```sh
Usage: ./nfqknockd [options]
Options:
  -f           Running foreground
  -a           Start port number for guard/knock diapazon (default 1)
  -b           End port number (default 65535)
  -p <port>    Guard TCP port (can be used multiple times)
  -P <port>    Opened TCP port (can be used multiple times)
  -t <seconds> Timeout for knock sequence (default: 10)
  -o <secret>  Open secret (default: helloworld123)
  -c <secret>  Close secret (default: goodbyeworld123)
  -s           Print current secret port sequences (OPEN: and CLOSE: for shell scripts)
  -d <digest>  Digest type - md5, sha256, sha384, sha512 (default: md5)
  -q <queue>   Netfilter queue number (default: 100)
  -m <maxlen>  Netfilter max queue length (default: 10000)
  -i           Create iptables rule with NFQUEUE target
  -h           Print this help
Decription:
  This is nfqknockd - daemon for guard TCP ports and open/close by
  cryptographically generated port-knocking sequences rotated every hour.
  It based on NFQUEUE library and require less resources than libpcap based.
  Not need interface working in promisc mode for capture knock packets.
Author:
  Kuzin Andrey <kuzinandrey@yandex.ru> 2025-11-04
Home:
   https://github.com/KuzinAndrey/nfqknock
Examples:
  ./nfqknockd -p 22 -p 443 -t 10 -o abracadabra -c ahalaymahalay -d sha256
  Protect ssh and https port from unknown connections.

  ./nfqknockd -o 123 -c 321 -s
  OPEN: 19161 3854 3145 22494 24404 19309 4462 13191
  CLOSE: 3116 25580 8203 7196 17537 13124 20176 1285
  Show port knock sequences for use in shell scripts to open/close protected ports.
```

## Configure SSH client

Use script `nfqknockd_ssh_wrapper` for wrap SSH connection to use port-knocking for open and close protected port.
Place it in on of `$PATH` directory, for example `$HOME/.local/bin` in my case:

```sh
echo $PATH
/home/avkuzin/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

cp nfqknockd_ssh_wrapper $HOME/.local/bin/
chmod +x $HOME/.local/bin/nfqknockd_ssh_wrapper
```
By default in this example script open secret '123' and close secret '321', don't forget change it for your needs.

Create new record in `$HOME/.ssh/config` for protected host:
```
Host develop1
    HostName 10.168.1.17
    User root
    Port 2222
    ProxyCommand sh -c "nfqknockd_ssh_wrapper %h %p"
    IdentityFile ~/.ssh/id_rsa
```

After that run on target host `nfqknockd` daemon by running command:
```sh
sudo nfqknockd -i -t 10 -p 2222 -o 123 -c 321
```
